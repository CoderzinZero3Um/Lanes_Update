{"ast":null,"code":"import React,{useState,useEffect,useReducer,useCallback,useContext,useRef}from\"react\";import{toast}from\"react-toastify\";import{makeStyles}from\"@material-ui/core/styles\";import Paper from\"@material-ui/core/Paper\";import Button from\"@material-ui/core/Button\";import Table from\"@material-ui/core/Table\";import TableBody from\"@material-ui/core/TableBody\";import TableCell from\"@material-ui/core/TableCell\";import TableHead from\"@material-ui/core/TableHead\";import TableRow from\"@material-ui/core/TableRow\";import IconButton from\"@material-ui/core/IconButton\";import SearchIcon from\"@material-ui/icons/Search\";import TextField from\"@material-ui/core/TextField\";import InputAdornment from\"@material-ui/core/InputAdornment\";import DeleteOutlineIcon from\"@material-ui/icons/DeleteOutline\";import EditIcon from\"@material-ui/icons/Edit\";import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import MainHeaderButtonsWrapper from\"../../components/MainHeaderButtonsWrapper\";import Title from\"../../components/Title\";import api from\"../../services/api\";import{i18n}from\"../../translate/i18n\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import TagModal from\"../../components/TagModal\";import ConfirmationModal from\"../../components/ConfirmationModal\";import toastError from\"../../errors/toastError\";import{Chip}from\"@material-ui/core\";import{socketConnection}from\"../../services/socket\";import{AuthContext}from\"../../context/Auth/AuthContext\";const reducer=(state,action)=>{if(action.type===\"LOAD_TAGS\"){return[...state,...action.payload];}// if (action.type === \"LOAD_TAGS\") {\n//   const tags = action.payload;\n//   const newTags = [];\n//   tags.forEach((tag) => {\n//     const tagIndex = state.findIndex((s) => s.id === tag.id);\n//     if (tagIndex !== -1) {\n//       state[tagIndex] = tag;\n//     } else {\n//       newTags.push(tag);\n//     }\n//   });\n//   return [...state, ...newTags];\n// }\nif(action.type===\"UPDATE_TAGS\"){const tag=action.payload;const tagIndex=state.findIndex(s=>s.id===tag.id);if(tagIndex!==-1){state[tagIndex]=tag;return[...state];}else{return[tag,...state];}}// if (action.type === \"DELETE_TAGS\") {\n//   const tagId = action.payload;\n//   const tagIndex = state.findIndex((s) => s.id === tagId);\n//   if (tagIndex !== -1) {\n//     state.splice(tagIndex, 1);\n//   }\n//   return [...state];\n// }\nif(action.type===\"DELETE_TAGS\"){const tagId=action.payload;return state.filter(tag=>tag.id!==tagId);}if(action.type===\"RESET\"){return[];}};const useStyles=makeStyles(theme=>({mainPaper:{flex:1,padding:theme.spacing(1),overflowY:\"scroll\",...theme.scrollbarStyles}}));const Tags=()=>{const classes=useStyles();const{user}=useContext(AuthContext);const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[hasMore,setHasMore]=useState(false);const[selectedTag,setSelectedTag]=useState(null);const[deletingTag,setDeletingTag]=useState(null);const[confirmModalOpen,setConfirmModalOpen]=useState(false);const[searchParam,setSearchParam]=useState(\"\");const[tags,dispatch]=useReducer(reducer,[]);const[tagModalOpen,setTagModalOpen]=useState(false);const pageNumberRef=useRef(1);const loadMore=()=>{setPageNumber(prevPageNumber=>prevPageNumber+1);};useEffect(()=>{const fetchMoreTags=async()=>{try{const{data}=await api.get(\"/tags/\",{params:{searchParam,pageNumber,kanban:0}});dispatch({type:\"LOAD_TAGS\",payload:data.tags});setHasMore(data.hasMore);setLoading(false);}catch(err){toastError(err);}};if(pageNumber>0){setLoading(true);fetchMoreTags();}},[searchParam,pageNumber]);useEffect(()=>{const socket=socketConnection({companyId:user.companyId});socket.on(\"company\".concat(user.companyId,\"-tag\"),data=>{if(data.action===\"update\"||data.action===\"create\"){dispatch({type:\"UPDATE_TAGS\",payload:data.tag});}if(data.action===\"delete\"){dispatch({type:\"DELETE_TAGS\",payload:+data.tagId});}});return()=>{socket.disconnect();};},[]);const handleOpenTagModal=()=>{setSelectedTag(null);setTagModalOpen(true);};const handleCloseTagModal=()=>{setSelectedTag(null);setTagModalOpen(false);};const handleSearch=event=>{setSearchParam(event.target.value.toLowerCase());};const handleEditTag=tag=>{setSelectedTag(tag);setTagModalOpen(true);};const handleDeleteTag=async tagId=>{try{await api.delete(\"/tags/\".concat(tagId));toast.success(i18n.t(\"tags.toasts.deleted\"));}catch(err){toastError(err);}setDeletingTag(null);setSearchParam(\"\");setPageNumber(1);};// const loadMore = () => {\n//   setPageNumber((prevState) => prevState + 1);\n// };\nconst handleScroll=e=>{if(!hasMore||loading)return;const{scrollTop,scrollHeight,clientHeight}=e.currentTarget;if(scrollHeight-(scrollTop+100)<clientHeight){loadMore();}};return/*#__PURE__*/React.createElement(MainContainer,{className:classes.mainContainer},/*#__PURE__*/React.createElement(ConfirmationModal,{title:deletingTag&&\"\".concat(i18n.t(\"tags.confirmationModal.deleteTitle\")),open:confirmModalOpen,onClose:setConfirmModalOpen,onConfirm:()=>handleDeleteTag(deletingTag.id)},i18n.t(\"tags.confirmationModal.deleteMessage\")),/*#__PURE__*/React.createElement(TagModal,{open:tagModalOpen,onClose:handleCloseTagModal,\"aria-labelledby\":\"form-dialog-title\",tagId:selectedTag&&selectedTag.id,kanban:0}),/*#__PURE__*/React.createElement(MainHeader,null,/*#__PURE__*/React.createElement(Title,null,i18n.t(\"tags.title\"),\" (\",tags.length,\")\"),/*#__PURE__*/React.createElement(MainHeaderButtonsWrapper,null,/*#__PURE__*/React.createElement(TextField,{placeholder:i18n.t(\"contacts.searchPlaceholder\"),type:\"search\",value:searchParam,onChange:handleSearch,InputProps:{startAdornment:/*#__PURE__*/React.createElement(InputAdornment,{position:\"start\"},/*#__PURE__*/React.createElement(SearchIcon,{style:{color:\"gray\"}}))}}),/*#__PURE__*/React.createElement(Button,{variant:\"contained\",color:\"primary\",onClick:handleOpenTagModal},i18n.t(\"tags.buttons.add\")))),/*#__PURE__*/React.createElement(Paper,{className:classes.mainPaper,variant:\"outlined\",onScroll:handleScroll},/*#__PURE__*/React.createElement(Table,{size:\"small\"},/*#__PURE__*/React.createElement(TableHead,null,/*#__PURE__*/React.createElement(TableRow,null,/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"tags.table.name\")),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"tags.table.contacts\")),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"tags.table.actions\")))),/*#__PURE__*/React.createElement(TableBody,null,/*#__PURE__*/React.createElement(React.Fragment,null,tags.map(tag=>{var _tag$contactTags;return/*#__PURE__*/React.createElement(TableRow,{key:tag.id},/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},/*#__PURE__*/React.createElement(Chip,{variant:\"outlined\",style:{backgroundColor:tag.color,textShadow:\"1px 1px 1px #000\",color:\"white\"},label:tag.name,size:\"small\"})),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},tag===null||tag===void 0?void 0:(_tag$contactTags=tag.contactTags)===null||_tag$contactTags===void 0?void 0:_tag$contactTags.length),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},/*#__PURE__*/React.createElement(IconButton,{size:\"small\",onClick:()=>handleEditTag(tag)},/*#__PURE__*/React.createElement(EditIcon,null)),/*#__PURE__*/React.createElement(IconButton,{size:\"small\",onClick:e=>{setConfirmModalOpen(true);setDeletingTag(tag);}},/*#__PURE__*/React.createElement(DeleteOutlineIcon,null))));}),loading&&/*#__PURE__*/React.createElement(TableRowSkeleton,{key:\"skeleton\",columns:3}))))));};export default Tags;","map":null,"metadata":{},"sourceType":"module"}